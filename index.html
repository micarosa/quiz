<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI í€´ì¦ˆ ë©”ì´ì»¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Stable PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- JSZip for PPTX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar -->
        <aside class="w-full md:w-80 bg-white border-r p-6 space-y-6">
            <div>
                <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                    <span>âš™ï¸</span> ì„¤ì •
                </h1>
                <p class="text-sm text-gray-500 mt-1">Gemini 1.5 Flash ëª¨ë¸ ì‚¬ìš©</p>
            </div>

            <div class="space-y-2">
                <label class="block text-sm font-semibold">Gemini API Key</label>
                <input type="password" id="apiKey" placeholder="AI Key ì…ë ¥..." 
                    class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <p id="keyWarning" class="text-xs text-orange-600 hidden">API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <div class="pt-4 border-t">
                <label class="block text-sm font-semibold mb-2">ë¬¸ì œ ìƒì„± ì„¤ì •</label>
                <div class="flex items-center justify-between text-sm">
                    <span>ë¬¸ì œ ìˆ˜: <span id="qCountVal">5</span>ê°œ</span>
                </div>
                <input type="range" id="qCount" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
            </div>
            
            <div class="p-4 bg-blue-50 rounded-lg text-xs text-blue-800">
                ğŸ’¡ <b>íŒ:</b> í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ìƒìœ„ 8,000ìë§Œ ë¶„ì„ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-10 max-w-5xl mx-auto w-full">
            <header class="mb-8">
                <h2 class="text-3xl font-extrabold mb-2">ğŸ“š AI ìˆ˜ì—… ìë£Œ í€´ì¦ˆ ìƒì„±ê¸°</h2>
                <p class="text-gray-600">PDF, PPTX, TXT íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ 4ì§€ ì„ ë‹¤í˜• í€´ì¦ˆë¥¼ ìƒì„±í•˜ì„¸ìš”.</p>
            </header>

            <!-- File Upload Area -->
            <div class="bg-white p-8 border-2 border-dashed border-gray-300 rounded-2xl text-center hover:border-blue-500 transition-colors mb-8 relative">
                <input type="file" id="fileInput" accept=".pdf,.pptx,.txt" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div id="uploadUI">
                    <div class="text-4xl mb-3">ğŸ“</div>
                    <p class="text-lg font-medium">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                    <p class="text-sm text-gray-400 mt-1">ì§€ì› í˜•ì‹: PDF, PPTX, TXT</p>
                </div>
                <div id="fileInfo" class="hidden">
                    <div class="flex items-center justify-center gap-2 text-blue-600 font-bold">
                        <span id="fileNameDisplay">íŒŒì¼ëª…</span>
                        <button onclick="resetFile()" class="text-gray-400 hover:text-red-500 text-sm font-normal underline">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mb-10">
                <button id="generateBtn" onclick="handleGenerate()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:bg-gray-400">
                    ğŸš€ í€´ì¦ˆ ìƒì„±í•˜ê¸°
                </button>
            </div>

            <!-- Loading State -->
            <div id="loader" class="hidden flex flex-col items-center justify-center py-10">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                <p class="text-gray-600 font-medium text-center">AIê°€ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë¬¸ì œë¥¼ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤...<br><span class="text-xs text-gray-400">(ì•½ 10~20ì´ˆ ì†Œìš”)</span></p>
            </div>

            <!-- Quiz List -->
            <div id="quizContainer" class="space-y-6"></div>

            <!-- Download Section -->
            <div id="downloadSection" class="hidden mt-10 pt-6 border-t flex justify-center">
                <button onclick="downloadCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-xl shadow-md flex items-center gap-2">
                    ğŸ“¥ í€´ì¦ˆ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </main>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold mb-2" id="alertTitle">ì•Œë¦¼</h3>
            <p class="text-gray-600 mb-6 text-sm" id="alertMsg"></p>
            <button onclick="closeAlert()" class="w-full bg-gray-900 text-white py-2 rounded-lg font-bold">í™•ì¸</button>
        </div>
    </div>

    <script>
        let currentQuizData = [];
        let extractedText = "";
        
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        document.getElementById('qCount').addEventListener('input', (e) => {
            document.getElementById('qCountVal').innerText = e.target.value;
        });

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('uploadUI').classList.add('hidden');
            document.getElementById('fileInfo').classList.remove('hidden');
            document.getElementById('fileNameDisplay').innerText = file.name;

            try {
                extractedText = await parseFile(file);
                if (!extractedText || !extractedText.trim()) {
                    throw new Error("íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                showAlert("ì˜¤ë¥˜", "íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨: " + error.message);
                resetFile();
            }
        });

        function resetFile() {
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadUI').classList.remove('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            extractedText = "";
        }

        function showAlert(title, msg) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMsg').innerText = msg;
            document.getElementById('customAlert').classList.remove('hidden');
        }

        function closeAlert() {
            document.getElementById('customAlert').classList.add('hidden');
        }

        async function parseFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (ext === 'pdf') {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(" ") + "\n";
                }
                return text;
            } else if (ext === 'txt') {
                return await file.text();
            } else if (ext === 'pptx') {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                let text = "";
                const slideFiles = Object.keys(zip.files).filter(name => name.startsWith('ppt/slides/slide') && name.endsWith('.xml'));
                for (const slide of slideFiles) {
                    const content = await zip.file(slide).async("text");
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(content, "text/xml");
                    const texts = xmlDoc.getElementsByTagName("a:t");
                    for (let t of texts) text += t.textContent + " ";
                }
                return text;
            }
            throw new Error("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.");
        }

        /**
         * API í˜¸ì¶œ ì‹œ v1 ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°
         */
        async function callGemini(prompt, apiKey) {
            // v1beta ëŒ€ì‹  v1ì„ ì‚¬ìš©í•˜ê±°ë‚˜, ëª¨ë¸ ì´ë¦„ì„ ëª…í™•íˆ ì „ë‹¬
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.2, // í€´ì¦ˆì˜ ì¼ê´€ì„±ì„ ìœ„í•´ ë‚®ì€ ì˜¨ë„ë¡œ ì„¤ì •
                    topP: 0.8,
                    maxOutputTokens: 2048,
                    responseMimeType: "application/json" // ìµœì‹  ëª¨ë¸ì€ JSON ì¶œë ¥ì„ ì§ì ‘ ì§€ì›
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json();
                console.error("API Response Error:", errData);
                throw new Error(errData.error?.message || "Gemini API ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }

            const data = await response.json();
            const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!rawText) throw new Error("AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
            
            try {
                // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° í›„ íŒŒì‹±
                const cleanJson = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
                const parsed = JSON.parse(cleanJson);
                return Array.isArray(parsed) ? parsed : [parsed];
            } catch (e) {
                // ìˆ˜ë™ íŒŒì‹± ì‹œë„ (Regex)
                const jsonMatch = rawText.match(/\[\s*\{.*\}\s*\]/s) || rawText.match(/\{.*\}/s);
                if (jsonMatch) return JSON.parse(jsonMatch[0]);
                throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨");
            }
        }

        async function handleGenerate() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const qCount = document.getElementById('qCount').value;

            if (!apiKey) {
                document.getElementById('keyWarning').classList.remove('hidden');
                showAlert("ì„¤ì • í™•ì¸", "ë¨¼ì € Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!extractedText) {
                showAlert("íŒŒì¼ í™•ì¸", "ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            setLoading(true);
            const prompt = `ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìŠµ ë‚´ìš©ì„ í™•ì¸í•˜ê¸° ìœ„í•œ 4ì§€ ì„ ë‹¤í˜• í€´ì¦ˆ ${qCount}ê°œë¥¼ ë§Œë“œì„¸ìš”.
                ë°˜ë“œì‹œ ì•„ë˜ì˜ JSON ë°°ì—´ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
                [
                  {
                    "question": "ë¬¸ì œ ë‚´ìš©",
                    "options": ["ë³´ê¸°1", "ë³´ê¸°2", "ë³´ê¸°3", "ë³´ê¸°4"],
                    "answer": "ë³´ê¸° ì¤‘ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì •ë‹µ ë¬¸ìì—´",
                    "explanation": "í•´ì„¤"
                  }
                ]
                ì–¸ì–´: í•œêµ­ì–´
                ë‚´ìš©: ${extractedText.substring(0, 8000)}`;

            try {
                currentQuizData = await callGemini(prompt, apiKey);
                renderQuizzes();
            } catch (err) {
                showAlert("ì˜¤ë¥˜", "ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            } finally {
                setLoading(false);
            }
        }

        async function regenerateQuiz(idx) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) return;

            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "âŒ›";

            const prompt = `ì œê³µëœ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡œìš´ 4ì§€ ì„ ë‹¤í˜• ë¬¸ì œ 1ê°œë§Œ ë§Œë“œì„¸ìš”. 
                ì´ì „ ë¬¸ì œì™€ ê²¹ì¹˜ì§€ ì•Šê²Œ í•˜ì„¸ìš”. JSON ê°ì²´ í•˜ë‚˜ë§Œ ë°˜í™˜í•˜ì„¸ìš”.
                ë‚´ìš©: ${extractedText.substring(0, 5000)}`;

            try {
                const result = await callGemini(prompt, apiKey);
                currentQuizData[idx] = result[0] || result;
                renderQuizzes();
            } catch (err) {
                showAlert("ì˜¤ë¥˜", "ì¬ìƒì„± ì‹¤íŒ¨: " + err.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function deleteQuiz(idx) {
            currentQuizData.splice(idx, 1);
            renderQuizzes();
        }

        function setLoading(val) {
            document.getElementById('generateBtn').disabled = val;
            document.getElementById('loader').classList.toggle('hidden', !val);
            if (val) {
                document.getElementById('quizContainer').innerHTML = "";
                document.getElementById('downloadSection').classList.add('hidden');
            }
        }

        function renderQuizzes() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = "";
            
            if (!currentQuizData || currentQuizData.length === 0) return;

            currentQuizData.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-2xl border shadow-sm animate-fadeIn flex flex-col md:flex-row gap-6";
                div.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-start gap-3 mb-4">
                            <span class="bg-blue-600 text-white text-xs font-bold px-2 py-1 rounded">Q${idx+1}</span>
                            <h4 class="text-lg font-bold">${item.question}</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            ${(item.options || []).map((opt, i) => `
                                <div class="p-3 border rounded-xl bg-gray-50 text-sm flex items-center gap-2">
                                    <span class="text-blue-500 font-bold">${i+1}.</span> ${opt}
                                </div>
                            `).join('')}
                        </div>
                        <details class="group border rounded-xl overflow-hidden">
                            <summary class="list-none p-3 bg-gray-100 cursor-pointer font-bold text-sm flex justify-between items-center hover:bg-gray-200">
                                ì •ë‹µ/í•´ì„¤ í™•ì¸ <span>â–¼</span>
                            </summary>
                            <div class="p-4 bg-blue-50 text-sm">
                                <p class="text-blue-700 font-bold mb-2">ì •ë‹µ: ${item.answer}</p>
                                <p class="text-gray-600 leading-relaxed">${item.explanation}</p>
                            </div>
                        </details>
                    </div>
                    <div class="flex md:flex-col gap-2 justify-end">
                        <button onclick="deleteQuiz(${idx})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold border border-red-100">ğŸ—‘ï¸ ì‚­ì œ</button>
                        <button onclick="regenerateQuiz(${idx})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg text-xs font-bold border border-blue-100">ğŸ”„ ì¬ìƒì„±</button>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('downloadSection').classList.remove('hidden');
        }

        function downloadCSV() {
            if (currentQuizData.length === 0) return;

            let csv = "\uFEFF"; // UTF-8-SIG
            csv += "ë²ˆí˜¸,ë¬¸ì œ,ë³´ê¸°1,ë³´ê¸°2,ë³´ê¸°3,ë³´ê¸°4,ì •ë‹µ,í•´ì„¤\n";

            currentQuizData.forEach((q, i) => {
                const opts = q.options || ["","","",""];
                const row = [
                    i + 1,
                    q.question,
                    opts[0], opts[1], opts[2], opts[3],
                    q.answer,
                    q.explanation
                ].map(text => `"${String(text).replace(/"/g, '""')}"`);
                csv += row.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `quiz_export_${new Date().getTime()}.csv`;
            link.click();
        }
    </script>
</body>
</html>
